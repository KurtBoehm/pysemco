\RequirePackage{l3keys2e}
\ProvidesExplPackage{demo/SemanticCode}{2024-08-20}{1.1}{Semantic code analysis and typesetting.}
\RequirePackage{fancyvrb}
\RequirePackage{xcolor}

% Unix time

\tl_new:N\g_unixtime_tl
\int_new:N\g_unixyear_int
\int_new:N\g_unixmonth_int
\int_new:N\g_unixday_int
\int_new:N\g_unixhour_int
\int_new:N\g_unixminute_int
\int_new:N\g_unixsecond_int

\regex_const:Nn\g_unixtime_regex{\A D:(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(?:Z|([+\-](\d+)'(\d+)'))\Z}

% #1: year
\cs_new:Nn\unixtime_leapyear:n{%
  \int_eval:n{
    1
    -\int_sign:n{\int_mod:nn{#1}{4}}
    +\int_sign:n{\int_mod:nn{#1}{100}}
    -\int_sign:n{\int_mod:nn{#1}{400}}
  }%
}
% #1: year
\cs_new:Nn\unixtime_leapoff:n{%
  \int_eval:n{
    \int_div_truncate:nn{#1}{4}
    - \int_div_truncate:nn{#1}{100}
    + \int_div_truncate:nn{#1}{400}
    - \unixtime_leapyear:n{#1}
    - 477
  }
}
% #1: year, #2: month
\cs_new:Nn\unixtime_monthoff:nn{%
  \int_eval:n{
    30 * (#2 - 1)
    - \int_sign:n{\int_max:nn{#2 - 2}{0}} * (2 - \unixtime_leapyear:n{#1})
    + \int_div_truncate:nn{(#2 + \int_sign:n{\int_max:nn{#2 - 8}{0}})}{2}
  }%
}
% #1: year, #2: month, #3: day
\cs_new:Nn\unixtime_dayoff:nnn{%
  \int_eval:n{(#1 - 1970) * 365 + \unixtime_leapoff:n{#1} + \unixtime_monthoff:nn{#1}{#2} + (#3 - 1)}%
}
% #1: Timestamp as described in the documentation of \file_timestamp:n
% #2: Destination
\cs_new:Nn\unixtime_parse:nN{%
  \regex_extract_once:NnN\g_unixtime_regex{#1}\l_tmpa_seq%
  \int_set:Nn\g_unixyear_int{\seq_item:Nn\l_tmpa_seq{2}}%
  \int_set:Nn\g_unixmonth_int{\seq_item:Nn\l_tmpa_seq{3}}%
  \int_set:Nn\g_unixday_int{\seq_item:Nn\l_tmpa_seq{4}}%
  \int_set:Nn\g_unixhour_int{\seq_item:Nn\l_tmpa_seq{5}}%
  \int_set:Nn\g_unixminute_int{\seq_item:Nn\l_tmpa_seq{6}}%
  \int_set:Nn\g_unixsecond_int{\seq_item:Nn\l_tmpa_seq{7}}%
  \tl_if_empty:eF{\seq_item:Nn\l_tmpa_seq{8}}{
    \int_add:Nn\g_unixhour_int{\seq_item:Nn\l_tmpa_seq{9}}%
    \int_add:Nn\g_unixminute_int{\seq_item:Nn\l_tmpa_seq{10}}%
  }%
  \int_set:Nn#2{
    (
      (
        \unixtime_dayoff:nnn{\g_unixyear_int}{\g_unixmonth_int}{\g_unixday_int} * 24
        + \g_unixhour_int
      ) * 60 + \g_unixminute_int
    ) * 60 + \g_unixsecond_int
  }%
}
\cs_generate_variant:Nn\unixtime_parse:nN{VN}
\cs_new:Nn\unixtime_file_get:nN{%
  \file_get_timestamp:nN{#1}\g_unixtime_tl%
  \unixtime_parse:VN\g_unixtime_tl#2%
}
\cs_new:Nn\unixtime_job:N{%
  \unixtime_parse:VN\c_sys_timestamp_str#1%
}
\cs_new:Nn\unixtime_file_age:nN{%
  \unixtime_file_get:nN{#1}\l_tmpa_int%
  \unixtime_job:N\l_tmpb_int%
  \int_set:Nn#2{\l_tmpb_int-\l_tmpa_int}%
}

% Based on https://tex.stackexchange.com/a/62032
\cs_new:Nn\env_query_raw:nN{\sys_get_shell:nnN{kpsewhich ~ --var-value ~ #1}{}#2}
\cs_new:Nn\env_query_path:nN{%
  \env_query_raw:nN{#1}#2%
  \tl_trim_spaces:N#2%
  \tl_if_empty:NTF#2{\tl_set:Nn#2{.}}{%
    \tl_if_eq:NnT#2{\par}{\tl_set:Nn#2{.}}%
  }%
}
\cs_new:Nn\env_query_path:N{\env_query_path:nN{TEXMF_OUTPUT_DIRECTORY}#1}

\definecolor{PictaGreyMedium}{HTML}{6e7781}
\definecolor{PictaGreyLight}{HTML}{8b949e}
\definecolor{PictaRedMedium}{HTML}{ce2233}
\definecolor{PictaRedLight}{HTML}{ff7a80}
\definecolor{PictaOrangeMedium}{HTML}{d76500}
\definecolor{PictaOrangeLight}{HTML}{ff9566}
\definecolor{PictaYellowMedium}{HTML}{bc8700}
\definecolor{PictaYellowLight}{HTML}{ffc960}
\definecolor{PictaOliveMedium}{HTML}{7c8200}
\definecolor{PictaOliveLight}{HTML}{c6ce59}
\definecolor{PictaGreenMedium}{HTML}{22893a}
\definecolor{PictaGreenLight}{HTML}{56da70}
\definecolor{PictaCyanMedium}{HTML}{00899b}
\definecolor{PictaCyanLight}{HTML}{50d4cf}
\definecolor{PictaBlueDark}{HTML}{0a3069}
\definecolor{PictaBlueMedium}{HTML}{0052ac}
\definecolor{PictaBlueLight}{HTML}{75bfff}
\definecolor{PictaBlueVeryLight}{HTML}{a5d6ff}
\definecolor{PictaIndigoMedium}{HTML}{633ac1}
\definecolor{PictaIndigoLight}{HTML}{c1b1ff}
\definecolor{PictaPurpleMedium}{HTML}{ab44c5}
\definecolor{PictaPurpleLight}{HTML}{e8a1ff}
\definecolor{PictaPinkMedium}{HTML}{d33887}
\definecolor{PictaPinkLight}{HTML}{ff9ec5}

\cs_new:Nn\semco_quasitt:{\cs_if_exist:NTF\codefamily{\codefamily}{\ttfamily}}

\prop_new:N\g_semco_style_prop
\prop_new:N\g_semco_styles_prop

\cs_new:Nn\semco_colorful_function:n{\textcolor{PictaGreenMedium}{#1}}
\cs_new:Nn\semco_colorful_keyword:n{\textcolor{PictaRedMedium}{#1}}
\cs_new:Nn\semco_colorful_constant:n{\textcolor{PictaBlueMedium}{#1}}
\cs_new:Nn\semco_colorful_member:n{\textit{#1}}
\cs_new:Nn\semco_colorful_type:n{\textcolor{PictaIndigoMedium}{#1}}
\cs_new:Nn\semco_colorful_variable:n{\textcolor{PictaOrangeMedium}{#1}}

\cs_new:Nn\semco_colorful_attr:n{\textcolor{PictaBlueMedium}{#1}}
\cs_new:Nn\semco_colorful_blt_var:n{\semco_colorful_variable:n{#1}}
\cs_new:Nn\semco_colorful_cls:n{\semco_colorful_type:n{#1}}
\cs_new:Nn\semco_colorful_com:n{\textcolor{PictaGreyMedium}{#1}}
\cs_new:Nn\semco_colorful_cnc:n{\textcolor{PictaPurpleMedium}{#1}}
\cs_new:Nn\semco_colorful_dec:n{\textcolor{PictaBlueMedium}{#1}}
\cs_new:Nn\semco_colorful_enm:n{\semco_colorful_constant:n{#1}}
\cs_new:Nn\semco_colorful_enu:n{\semco_colorful_type:n{#1}}
\cs_new:Nn\semco_colorful_fun:n{\semco_colorful_function:n{#1}}
\cs_new:Nn\semco_colorful_kwd:n{\semco_colorful_keyword:n{#1}}
\cs_new:Nn\semco_colorful_kwd_val:n{\semco_colorful_keyword:n{\semco_colorful_constant:n{#1}}}
\cs_new:Nn\semco_colorful_kwd_fun:n{\semco_colorful_keyword:n{\semco_colorful_function:n{#1}}}
\cs_new:Nn\semco_colorful_kwd_typ:n{\semco_colorful_keyword:n{\semco_colorful_type:n{#1}}}
\cs_new:Nn\semco_colorful_lab:n{\textcolor{PictaBlueMedium}{#1}}
\cs_new:Nn\semco_colorful_lit_aff:n{\textcolor{PictaRedMedium}{#1}}
\cs_new:Nn\semco_colorful_lit_chr:n{\semco_colorful_constant:n{#1}}
\cs_new:Nn\semco_colorful_lit_flt:n{\semco_colorful_constant:n{#1}}
\cs_new:Nn\semco_colorful_lit_inc:n{\semco_colorful_constant:n{#1}}
\cs_new:Nn\semco_colorful_lit_int:n{\semco_colorful_constant:n{#1}}
\cs_new:Nn\semco_colorful_lit_str:n{\textcolor{PictaBlueDark}{#1}}
\cs_new:Nn\semco_colorful_mac:n{\textcolor{PictaBlueMedium}{#1}}
\cs_new:Nn\semco_colorful_mtd:n{\semco_colorful_member:n{\semco_colorful_function:n{#1}}}
\cs_new:Nn\semco_colorful_nms:n{\textcolor{PictaPinkMedium}{#1}}
\cs_new:Nn\semco_colorful_par:n{\textbf{\semco_colorful_variable:n{#1}}}
\cs_new:Nn\semco_colorful_pre:n{\semco_colorful_keyword:n{#1}}
\cs_new:Nn\semco_colorful_pro:n{\semco_colorful_member:n{\semco_colorful_variable:n{#1}}}
\cs_new:Nn\semco_colorful_tpa:n{\textbf{\semco_colorful_type:n{#1}}}
\cs_new:Nn\semco_colorful_typ:n{\semco_colorful_type:n{#1}}
\cs_new:Nn\semco_colorful_var:n{\semco_colorful_variable:n{#1}}

\cs_new:Nn\semco_bw_mem:n{\textit{#1}}
\cs_new:Nn\semco_bw_com:n{\textcolor{gray}{#1}}
\cs_new:Nn\semco_bw_kwd:n{\textbf{#1}}

\cs_new:Nn\semco_style_colorful:{
  \prop_gset_from_keyval:Nn\g_semco_style_prop{
    attribute         = {\semco_colorful_attr:n},
    builtin-variable  = {\semco_colorful_blt_var:n},
    class             = {\semco_colorful_cls:n},
    comment           = {\semco_colorful_com:n},
    concept           = {\semco_colorful_cnc:n},
    decorator         = {\semco_colorful_dec:n},
    enum              = {\semco_colorful_enu:n},
    enumMember        = {\semco_colorful_enm:n},
    function          = {\semco_colorful_fun:n},
    keyword           = {\semco_colorful_kwd:n},
    keyword-fun       = {\semco_colorful_kwd_fun:n},
    keyword-type      = {\semco_colorful_kwd_typ:n},
    keyword-value     = {\semco_colorful_kwd_val:n},
    label             = {\semco_colorful_lab:n},
    literal-affix     = {\semco_colorful_lit_aff:n},
    literal-character = {\semco_colorful_lit_chr:n},
    literal-float     = {\semco_colorful_lit_flt:n},
    literal-include   = {\semco_colorful_lit_inc:n},
    literal-int       = {\semco_colorful_lit_int:n},
    literal-string    = {\semco_colorful_lit_str:n},
    macro             = {\semco_colorful_mac:n},
    method            = {\semco_colorful_mtd:n},
    namespace         = {\semco_colorful_nms:n},
    parameter         = {\semco_colorful_par:n},
    preprocessor      = {\semco_colorful_pre:n},
    property          = {\semco_colorful_pro:n},
    type              = {\semco_colorful_typ:n},
    typeParameter     = {\semco_colorful_tpa:n},
    variable          = {\semco_colorful_var:n},
  }
}
\cs_new:Nn\semco_style_bw:{
  \prop_gset_from_keyval:Nn\g_semco_style_prop{
    comment       = {\semco_bw_com:n},
    keyword       = {\semco_bw_kwd:n},
    keyword-type  = {\semco_bw_kwd:n},
    keyword-value = {\semco_bw_kwd:n},
    method        = {\semco_bw_mem:n},
    property      = {\semco_bw_mem:n},
  }
}
\prop_gset_from_keyval:Nn\g_semco_styles_prop{
  bw       = {\semco_style_bw:},
  colorful = {\semco_style_colorful:},
}

\semco_style_colorful:{}

\keys_define:nn{semco_keys}{
  style.code:n = {\prop_item:Nn\g_semco_styles_prop{#1}},
  style.value_required:n = true,
}
\ProcessKeysOptions{semco_keys}

\NewDocumentCommand{\SemCoSetup}{m}{\keys_set:nn{semco_keys}{#1}}

\newlength{\SemCoSpaceLength}
\NewDocumentEnvironment{SemCoFormatEnv}{}{%
  \par\noindent\hbadness=10000%
  \ttfamily%
  \settowidth{\SemCoSpaceLength}{\ }%
}{%
  \par%
}
\newlanguage\cpp
\NewDocumentCommand{\SemCoFormatInlineImpl}{m}{%
  {%
    \language=\cpp%
    \semco_quasitt:%
    \settowidth{\SemCoSpaceLength}{\ }%
    #1%
  }%
}
\NewDocumentCommand{\SemCoFormatInline}{m}{%
  \if_mode_math:%
    \text{\SemCoFormatInlineImpl{#1}}%
  \else:%
    \SemCoFormatInlineImpl{#1}%
  \fi:%
}
\NewDocumentCommand{\SemCoSpace}{}{\hspace*{\SemCoSpaceLength}}%
\NewDocumentCommand{\SemCoBackSlash}{}{\textbackslash}
\NewDocumentCommand{\SemCoFormat}{m m}{%
  \prop_get:NnNTF\g_semco_style_prop{#1}\l_tmpa_tl{\l_tmpa_tl{#2}}{#2}%
}

\iow_new:N\g_semco_code_iow
\tl_new:N\g_semco_output_dir
\tl_new:N\g_semco_hex_tl
\tl_new:N\g_semco_vrb_path
\prop_new:N\g_semco_part_prop
\prop_new:N\g_semco_mini_prop

\cs_new:Nn\semco_vrb_name:{vrb.tmp}

\cs_generate_variant:Nn\str_replace_all:Nnn{Nnx}
\cs_generate_variant:Nn\sys_get_shell:nnN{enN}

% #1: Destination, #2: Source
\cs_new:Nn\semco_tl_to_str:NN{%
  \str_set:NV#1#2%
  \str_replace_all:Nnx#1{##}{\c_hash_str}%
}
\cs_new:Nn\semco_tl_to_str:Nn{%
  \str_set:Nn#1{#2}%
  \str_replace_all:Nnx#1{##}{\c_hash_str}%
}

\sys_shell_now:n{mkdir ~ -p ~ .semco}

% Initialize/update if pysemco_tex does not exist or is more than 24 hours old
\cs_new:Nn\semco_venv_init:{
  \sys_shell_now:n{rm ~ -rf ~ .semco/*}
  \sys_shell_now:n{python3 ~ -m ~ venv ~ .semco/venv}
  \sys_shell_now:n{./.semco/venv/bin/pip3 ~ install ~ -e ~ .}
}
\file_if_exist:nTF{.semco/venv/bin/pysemco_tex}{
  \int_new:N\g_semco_age_int
  \unixtime_file_age:nN{.semco/venv/bin/pysemco_tex}\g_semco_age_int
  \tl_log:e{pysemco_tex~age:~\int_use:N\g_semco_age_int}
  \int_compare:nT{\g_semco_age_int > 86400}{\semco_venv_init:}
}{\semco_venv_init:}

\sys_shell_now:n{echo ~ "*" ~ > ~ .semco/.gitignore}
\sys_shell_now:n{touch ~ .semco/.cache}

\NewDocumentCommand{\@semco@store@part@cache}{o m m m}{%
  \prop_gput:Nee\g_semco_part_prop{{#1}{#2}{#3}}{#4}%
}
\NewDocumentCommand{\@semco@store@mini@cache}{m m m}{%
  \prop_gput:Nee\g_semco_mini_prop{{#1}{#2}}{#3}%
}
\ExplSyntaxOff
\input{.semco/.cache}
\ExplSyntaxOn

% Set \g_semco_vrb_path to the path of the VRB file
\cs_new:Nn\semco_setup_vrb:{%
  \env_query_path:N\g_semco_output_dir%
  \tl_set:Nn\g_semco_vrb_path{\g_semco_output_dir/\semco_vrb_name:}%
}
% Write #1 to the SemCo VRB file and set \g_semco_vrb_path to the corresponding path
\cs_new:Nn\semco_write_vrb:n{%
  \iow_open:Nn\g_semco_code_iow{\semco_vrb_name:}%
  \iow_now:Nn\g_semco_code_iow{#1}%
  \iow_close:N\g_semco_code_iow%
  \semco_setup_vrb:%
}
% Remove the VRB file created by \semco_write_vrb:n again
\cs_new:Nn\semco_clean_vrb:{%
  \sys_shell_now:e{rm ~ '\g_semco_vrb_path'}%
}

% #1: language
% #2: code name to refer to later
% #3: root
% #4: file name relative to root
\NewDocumentCommand{\SemCoAnalyze}{m m m m}{%
  \sys_get_shell:enN{.semco/venv/bin/pysemco_tex ~ analyze ~ #1 ~ '#3' ~ '#3/#4' ~ '.semco/#2.json'}{}\g_tmpa_tl%
  \tl_trim_spaces:N\g_tmpa_tl%
  \tl_if_eq:NnTF\g_tmpa_tl{1}{%
    % clean cache
    \sys_shell_now:n{rm ~ .semco/.cache}%
    \sys_shell_now:n{touch ~ .semco/.cache}%
    \prop_clear:N\g_semco_part_prop%
    \prop_clear:N\g_semco_mini_prop%
  }%
}

% #1: additional parameters
% #2: code name
\NewDocumentCommand{\SemCoInput}{O{} m}{%
  \sys_get_shell:enN{.semco/venv/bin/pysemco_tex ~ texify ~ '#1' ~ '.semco/#2.json'}{}\g_tmpa_tl%
  \begin{SemCoFormatEnv}\tl_use:N\g_tmpa_tl\end{SemCoFormatEnv}%
}

% #1: index of occurrence
% #2: code name
% #3: part
\NewDocumentCommand{\SemCoInputPart}{o m m}{%
  \semco_write_vrb:n{#3}%
  \file_get_hex_dump:nN{\semco_vrb_name:}\g_semco_hex_tl%
  \prop_get:NxNF\g_semco_part_prop{{#1}{#2}{\g_semco_hex_tl}}\g_tmpa_tl{%
    \sys_get_shell:enN{.semco/venv/bin/pysemco_tex ~ texify_partial ~ \IfValueT{#1}{--index ~ #1} ~ '.semco/#2.json' ~ '\g_semco_vrb_path'}{}\g_tmpa_tl%
    \prop_gput:Nxx\g_semco_part_prop{{#1}{#2}{\g_semco_hex_tl}}{\g_tmpa_tl}%
    \sys_shell_now:e{echo ~ '\string\@semco@store@part@cache\IfValueT{#1}{[#1]}{#2}{\g_semco_hex_tl}{\g_tmpa_tl}' ~ >> ~ .semco/.cache}%
  }%
  \semco_clean_vrb:{}%
  \SemCoFormatInline{\tl_use:N\g_tmpa_tl}%
}

% #1: language
% #2: code
\NewDocumentCommand{\SemCoMini}{m m}{%
  \semco_write_vrb:n{#2}%
  \file_get_hex_dump:nN{\semco_vrb_name:}\g_semco_hex_tl%
  \prop_get:NxNF\g_semco_mini_prop{{#1}{\g_semco_hex_tl}}\g_tmpa_tl{%
    \sys_get_shell:enN{.semco/venv/bin/pysemco_tex ~ texify_minimal ~ #1 ~ '\g_semco_vrb_path'}{}\g_tmpa_tl%
    \prop_gput:Nxx\g_semco_mini_prop{{#1}{\g_semco_hex_tl}}{\g_tmpa_tl}%
    \sys_shell_now:e{echo ~ '\string\@semco@store@mini@cache{#1}{\g_semco_hex_tl}{\g_tmpa_tl}' ~ >> ~ .semco/.cache}%
  }%
  \semco_clean_vrb:{}%
  \SemCoFormatInline{\tl_use:N\g_tmpa_tl}%
}

% #1: language
\NewDocumentEnvironment{SemCoMiniEnv}{O{} m}{%
  \VerbatimOut{\semco_vrb_name:}%
}{%
  \endVerbatimOut%
  \semco_setup_vrb:%
  \sys_get_shell:enN{.semco/venv/bin/pysemco_tex ~ texify_minimal_file ~ '#1' ~ '#2' ~ '\g_semco_vrb_path'}{}\g_tmpa_tl%
  \semco_clean_vrb:{}%
  \begin{SemCoFormatEnv}%
    \tl_use:N\g_tmpa_tl%
  \end{SemCoFormatEnv}%
}

% #1: language
% #2: code name to refer to later
\NewDocumentEnvironment{SemCoAnalyzeEnv}{m m}{%
  \VerbatimOut{\semco_vrb_name:}%
}{%
  \endVerbatimOut%
  \semco_setup_vrb:%
  \SemCoAnalyze{#1}{#2}{\g_semco_output_dir}{\semco_vrb_name:}%
  \semco_clean_vrb:{}%
}
